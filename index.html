<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" type="text/css" href="twittler.css">
  </head>
  <body>
    <script>
      var logsOn = true;

      var twittlerScope = {};
      twittlerScope.maxTweets = 20;
      twittlerScope.lastUpdatedTime = 0;
      twittlerScope.lastUpdatedBy = '';
      twittlerScope.users = [];

      log('start');
      //getting tweets
      $(document).ready(function(){
        setTimeout(function(){
          log('first update'); 
          update()
        }, 3000);
        setInterval(function(){
            update();
        }, 10000);

        //tabs
        $('.tab').hide();
        $('.currentTab').show();
        $('.tabItem.current').addClass('activeTab');
        //itab buttons settings 
        $('.tabItem.current').data('tab', 'currentTab');
        $('.tabItem.archive').data('tab', 'archiveTab');

        //tab eventv listener
        $('.tabItem').click(function(){
          //tab buttons
          $('tabItem').removeClass('activeTab');
          $(this).addClass('activeTab');
          //tab 
          $('.tab').hide();
          $('.tab.' + $(this).data('tab')).show();
        });

        //user listing
        $('.userToggle.allUser').click(function(){
          userListingClick($('.userToggle'), $('.tweet'));
        }).hover(function(){
          userListingHover($(this), true);
        },
        function(){
          userListingHover($(this), false);
        });

        //
      });

      /*
      * $user: the user that was clicked
      * $tweets: the list of tweets to show or hide
      */
      function userListingClick($users, $tweets){
        $users.toggleClass('toggleShow', !$users.first().hasClass('toggleShow'));
        $users.toggleClass('toggleHide', !$users.first().hasClass('toggleHide'));
        log($users.size() + '|' + $users.hasClass('toggleShow'));
        if ($users.first().hasClass('toggleShow')) {
          $tweets.show();
        } else {
          $tweets.hide();
        }
      }

      function userListingHover ($user, isHover){
        if (isHover){
          $user.addClass('hover');
        } else {
          $user.removeClass('hover');
        }
      }

      /*
      * 1. move previous new update result to be with old results
      * 2. check size of old results, archive extras
      * 3. populate new results, and check is any new user comes up, create a new user tag if so
      */
      function update(){
        var $newHolder = $('.newHolder');
        var $oldHolder = $('.oldHolder');
        var $archive = $('.archiveHolder');
        //move former new tweets to old tweets
        log('moving old');
        while ($newHolder.children().length > 0){
          $newHolder.children().last().prependTo($oldHolder);
        }
        //move excess tweets to archive
        log('archiving');
        while ($oldHolder.children().length > twittlerScope.maxTweets){
          $archive.prepend($oldHolder.children().last());
        }
        //get new tweets
        log('new tweets');
        var index = streams.home.length - 1;
        while (index >= 0 && 
                (streams.home[index].created_at > twittlerScope.lastUpdatedTime || 
                  (streams.home[index].created_at == twittlerScope.lastUpdatedTime && streams.home[index].user != twittlerScope.lastUpdatedBy))) {
          $newHolder.append(makeTweet(streams.home[index]));
          if ($('.userToggle.' + streams.home[index].user).size() == 0){
            var $newUser = makeUserListing(streams.home[index].user);
            $newUser.data('name', streams.home[index].user);
            $('.userList').append($newUser);
            $newUser.click(function(){
              userListingClick($(this), $('.tweet.' + $(this).data('name')))
            });
            $newUser.hover(function(){
              userListingHover($(this), true);
            },
            function(){
              userListingHover($(this), false);
            });
          }
          index -= 1;
        } 
        twittlerScope.lastUpdatedTime = streams.home[streams.home.length - 1].created_at;
        twittlerScope.lastUpdatedBy = streams.home[streams.home.length - 1].user;
      }

      /*
      * make a tweet $ from an object
      *
      * tweet: the object from the stream service
      */
      function makeTweet(tweet){
        var $tweet = $('<div class="tweet ' + tweet.user + '"></div>');
        var tweetText = '';
        $tweet.append($('<div class="tweetTime">' + timeStamp(tweet.created_at) + '</div>'));
        $tweet.append($('<div class="tweetUser">' + tweet.user + '</div>'));
        $tweet.append($('<div class="tweetContent">' + tweet.message + '</div>'));
        return $tweet;
      }

      /*
      * make a user $ from a name
      */
      function makeUserListing(username){
        return ($('<div class="userToggle ' + username + ' toggleShow">' + username + '</div>'));
      }

      function timeStamp(time){
        return time.toString();
      }

      function log(msg) {
        setTimeout(function() {
          if(logsOn) {
            throw new Error(msg);
          }
        }, 0);
      }
    </script>
    <!-- content -->
    <div class="page">
      <div class="header">
        Twttler
      </div>
      <div class="leftPanel">
        <div class="profile">
          name and stuff
        </div>
        <div class="optionList">
          options and stuff
        </div>
        <div class="userList">
          <div class="userToggle allUser toggleShow">All (Click to Toggle)</div> 
        </div>
      </div>
      <div class="main">
        <div class="tabMenu">
          <div class="tabItem current">Current</div>
          <div class="tabItem archive">Archive</div>
        </div>
        <div class="tab currentTab">
          <div class="holder newHolder">
          </div>
          <div class="holder oldHolder">
          </div>
        </div>
        <div class="tab archiveTab">
          <div class="holder archiveHolder">
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
