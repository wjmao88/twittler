<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" type="text/css" href="twittler.css">
  </head>
  <body>
    <script>
      var logsOn = true;
      function log(msg) {
        setTimeout(function() {
          if(logsOn) {
            throw new Error(msg);
          }
        }, 0);
      }
      //============================================================
      var twittlerScope = {};
      twittlerScope.maxTweets = 10;
      twittlerScope.lastUpdatedTime = 0;
      twittlerScope.lastUpdatedBy = '';
      twittlerScope.users = [];
      twittlerScope.autoInterval = 5000;
      twittlerScope.nameLength = 20;
      //============================================================
      $(document).ready(function(){
        log('loaded, begin');
        initialState();
        registerListeners();
        autoStart();
      });
      //============================================================
      function autoStart(){
        log('auto start');
        setTimeout(function(){
          update()
        }, twittlerScope.autoInterval);
        setInterval(function(){
            update();
        }, twittlerScope.autoInterval);
      }

      function initialState(){
        //naming
        $('.nameField').val('Anonymous');
        changeName(true);
         //tabs
        $('.tab').hide();
        $('.currentTab').show();
        $('.tabItem.current').addClass('activeTab');
        //itab buttons settings 
        $('.tabItem.current').data('tab', 'currentTab');
        $('.tabItem.archive').data('tab', 'archiveTab');
      }

      function registerListeners(){
        //changing names
        $('#edit').click(function(){
          $('#edit').hide();
          $('#ok').show();
          $('#cancel').show();
          $('.nameField').show();
          $('.nameLabel').hide();
          $('.nameField').focus();

        });

        $('#ok').click(function(){
          var msg = validateName($('.nameField').val());
          if (msg.length > 0){
            $('.nameAlert').text(msg);
          }else {
            $('.nameAlert').text('');
            changeName(true);
          }
        });

        $('#cancel').click(function(){
          changeName(false);
        });

        //sending tweet
        $('.draft').keypress(function(key){
          if (key.which == 10 && key.ctrlKey){
            doSend();
          }
        })

        $('#send').click(function(){
          doSend();
          update();
        })

        //tabs
        $('.tabItem').click(function(){
          //tab buttons
          $('.tabItem').removeClass('activeTab');
          $(this).addClass('activeTab');
          //tab 
          $('.tab').hide();
          $('.tab.' + $(this).data('tab')).show();
        });

        //user toggles
        $('.userToggle.allUser').click(function(){
          userListingClick($('.userToggle'), $('.tweet'));
        }).hover(function(){
          userListingHover($(this), true);
        },
        function(){
          userListingHover($(this), false);
        });
      }
      //============================================================
      function doSend(){
        window.visitor =  $('.nameLabel').text();
        writeTweet($('.draft').val());
        $('.draft').val('');
      }

      function changeName(oked){       
        if (oked){
          $('.nameLabel').text($('.nameField').val());
        } else {
          $('.nameField').val($('.nameLabel').text());
        }
        $('#edit').show();
        $('#ok').hide();
        $('#cancel').hide();
        $('.nameField').hide();
        $('.nameLabel').show();
      }

      function validateName(name){
        if (name.length == 0){
          return 'name is empty!';
        }
        if (name.length > twittlerScope.nameLength){
          return 'must be less than ' + twittlerScope.nameLength + 'characters';
        }
        var arr = name.split('');
        var test = 'QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890'
        for (var i = 0; i < name.length; i++){
          if (test.indexOf(name[i]) == -1){
            return 'can only contain alphanumeric';
          }
        }
        return '';
      }

      /*
      * $user: the user that was clicked
      * $tweets: the list of tweets to show or hide
      */
      function userListingClick($users, $tweets){
        $users.toggleClass('toggleShow', !$users.first().hasClass('toggleShow'));
        $users.toggleClass('toggleHide', !$users.first().hasClass('toggleHide'));
        log($users.size() + '|' + $users.hasClass('toggleShow'));
        if ($users.first().hasClass('toggleShow')) {
          $tweets.show();
        } else {
          $tweets.hide();
        }
      }

      function userListingHover ($user, isHover){
        if (isHover){
          $user.addClass('hover');
        } else {
          $user.removeClass('hover');
        }
      }

      /*
      * 1. move previous new update result to be with old results
      * 2. check size of old results, archive extras
      * 3. populate new results, and check is any new user comes up, create a new user tag if so
      */
      function update(){
        var $newHolder = $('.newHolder');
        var $oldHolder = $('.oldHolder');
        var $archive = $('.archiveHolder');
        //update time description
        $('.tweet').each(function(){
          $($(this).children()[0]).text(timeString($($(this).children()[1]).text()));
        })
        //move former new tweets to old tweets
        while ($newHolder.children().length > 0){
          $newHolder.children().last().prependTo($oldHolder);
        }
        //move excess tweets to archive
        while ($oldHolder.children().length > twittlerScope.maxTweets){
          $archive.prepend($oldHolder.children().last());
        }
        //get new tweets
        var index = streams.home.length - 1;
        while (index >= 0 && 
                (streams.home[index].created_at > twittlerScope.lastUpdatedTime || 
                  (streams.home[index].created_at == twittlerScope.lastUpdatedTime && streams.home[index].user != twittlerScope.lastUpdatedBy))) {
          $newHolder.append(makeTweet(streams.home[index]));
          if ($('.userToggle.' + streams.home[index].user).size() == 0){
            log('new user: ' + streams.home[index].user);
            var $newUser = makeUserListing(streams.home[index].user);
            $newUser.data('name', streams.home[index].user);
            $('.userList').append($newUser);
            $newUser.click(function(){
              userListingClick($(this), $('.tweet.' + $(this).data('name')))
            });
            $newUser.hover(function(){
              userListingHover($(this), true);
            },
            function(){
              userListingHover($(this), false);
            });
          }
          index -= 1;
        } 
        twittlerScope.lastUpdatedTime = streams.home[streams.home.length - 1].created_at;
        twittlerScope.lastUpdatedBy = streams.home[streams.home.length - 1].user;
      }

      /*
      * make a tweet $ from an object
      *
      * tweet: the object from the stream service
      */
      function makeTweet(tweet){
        var $tweet = $('<div class="tweet ' + tweet.user + '"></div>');
        var tweetText = '';
        $tweet.append($('<div class="tweetTime">' + timeString(tweet.created_at.getTime())+ '</div>'));
        $tweet.append($('<div class="tweetTimeStamp hide">' + tweet.created_at.getTime() + '</div>'));
        $tweet.append($('<div class="tweetUser"><div class="newTag">*NEW*</div> from: ' + tweet.user + '</div>'));
        $tweet.append($('<div class="tweetContent">' + tweet.message + '</div>'));
        return $tweet;
      }

      /*
      * make a user $ from a name
      */
      function makeUserListing(username){
        return ($('<div class="userToggle ' + username + ' toggleShow">' + username + '</div>'));
      }

      function timeString(time){
        var time = Date.now() - time;
        var str = ' ago.'
        log(time + ' ' +  time/60000  + ' ' +  time/3600000 + ' ' + time/(3600000 * 24));
        if (time < 60000) {
          return 'a few seconds ago';
        }
        if (time/60000 >= 1){
          str = Math.floor(time/60000) + ((Math.floor(time/60000) == 1)? ' minute' : ' minutes') + str;
        }
        if (time/3600000 >= 1){
          str = Math.floor(time/3600000) + ((Math.floor(time/3600000)) == 1? ' hour' : ' hours') + str;
        }
        if (time/(3600000 * 24) >= 1){
          str = Math.floor(time/(3600000 * 24)) + ((Math.floor(time/(3600000 * 24)) == 1)? ' day' : ' days') + str;
        }
        return str;
      }
    </script>
    <!-- content -->
    <div class="page">
      <div class="header">
        Twittler
      </div>
      <div class="leftPanel">
        <div class="profile">
          <div class="name"> 
            <div class="nameLabel"></div>
            <input class="nameField" type="text"> </input>
            <div class="nameAlert"></div>
          </div>
          <div class="nameButtons">
            <div class="nameButton" id="edit">Edit Name</div>
            <div class="nameButton" id="ok">Confirm</div>
            <div class="nameButton" id="cancel">Cancel</div>
          </div>
        </div>
        <div class="userList">
          <div class="userToggle allUser toggleShow">All (Click to Toggle)</div> 
        </div>
      </div>
      <div class="main">
        <div class="myTweet">
          <textarea class="draft"></textarea>
          <div class="buttons">
            <button class="button" id="clear">Clear</button>
            <button class="button" id="send">Ctrl+Enter</br>to Send</button>
          </div>
        </div>
        <div class="tabMenu">
          <div class="tabItem current">Current</div>
          <div class="tabItem archive">Archive</div>
        </div>
        <div class="tab currentTab">
          <div class="holder newHolder">
          </div>
          <div class="holder oldHolder">
          </div>
        </div>
        <div class="tab archiveTab">
          <div class="holder archiveHolder">
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
